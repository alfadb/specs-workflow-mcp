# 测试用例：确认未准备好的文档
name: "确认未准备好的文档"
description: "测试尝试确认还包含模板标记的文档"
category: "confirm"
priority: "high"

setup:
  fixtures: "fixtures/requirements/not-edited"
  target: "./e2e-test-confirm-not-ready"

request:
  method: "tools/call"
  params:
    name: "specs-workflow"
    arguments:
      path: "./e2e-test-confirm-not-ready"
      action:
        type: "confirm"

expect:
  operation: "confirm"
  error: true  # 文档包含模板标记时，confirm 操作应该失败
  error_checks:
    - type: "error_message"
      contains: "Document not ready for confirmation"
      description: "错误信息应该提到文档未准备好"
    - type: "error_message"
      contains: "template markers"
      description: "错误信息应该提到模板标记"
    - type: "error_message"
      contains: 'action.type="skip"'
      description: "错误信息应该提示可以使用 skip"
  additional_checks:
    # 验证错误不产生副作用
    - type: "file_content"
      path: "./e2e-test-confirm-not-ready/.workflow-confirmations.json"
      contains: '"requirements":false'
      description: "需求阶段应该保持未确认状态"
    # file_not_exists 检查需要验证是否支持
    - type: "file_content"
      path: "./e2e-test-confirm-not-ready/requirements.md"
      contains: "<template-requirements>"
      description: "需求文档应该保持原有模板标记"

cleanup: ["./e2e-test-confirm-not-ready"]